## 1. 프로젝트 개요
- **프로젝트 명**: MarryDay (맞춤형 웨딩드레스 가상 피팅 플랫폼)
- **요약**: 사용자가 전신 또는 얼굴 이미지를 업로드하면 AI가 체형·취향에 맞는 웨딩드레스를 자동 매칭·추천하여 가상 피팅 이미지를 생성하는 서비스.
- **참고 문서**: `docs/all_in_one.md`

---

## 2. 비즈니스 배경 및 목표
- **시장 문제**
  - 오프라인 피팅의 시간·비용·예약 부담.
  - 단순 카탈로그 기반 추천의 한계로 인한 구매 결정 지연.
  - 국내 웨딩 스튜디오/드레스샵의 온라인 전환 수요 증가.
- **비즈니스 목표 (12개월)**
  - 웨딩드레스 브랜드·샵 파트너 30곳 이상 확보.
  - 월간 활성 사용자(MAU) 2만 명 달성.
  - 가상 피팅 후 실제 상담 전환율 15% 이상.
  - S3 이미지 처리 비용 대비 평균 세션당 1.5배 수익 확보(프리미엄 구독·파트너 수수료).
- **가치 제안**
  - 개인 체형/스타일에 최적화된 추천을 즉시 시각화.
  - 고품질 이미지 합성으로 실제 착용에 가까운 경험 제공.
  - 파트너사 입장에서는 디지털 샘플 관리 및 고객 리드 확보 채널.

---

## 3. 사용자 및 페르소나
- **예비 신부(Primary)**: 온라인에서 드레스 리서치를 선호하며, 자신의 체형에 맞는 드레스 핏을 빠르게 확인하고 싶은 사용자.
- **웨딩 플래너(Secondary)**: 고객 상담 전에 다양한 드레스 옵션을 시각적으로 제안하고 싶은 전문가.
- **드레스 샵 운영자(Tertiary)**: 재고·핏 정보를 온라인으로 홍보하고 신규 고객을 유치하려는 파트너.

---

## 4. 사용자 여정
1. **온보딩**
   - 프로필 입력(키/몸무게/사이즈/선호 스타일) 또는 SNS 로그인 연동.
   - 개인정보 및 이미지 사용 동의 수집.
2. **이미지 업로드**
   - 전신 또는 상반신 사진 업로드.
   - 가이드라인(포즈, 조명, 배경) 안내 및 자동 검증(품질 부족 시 재업로드 요청).
3. **AI 분석 및 드레스 추천**
   - 체형 분석(어깨·허리·엉덩이 비율)과 스타일 선호도를 기반으로 드레스 리스트 추천.
   - 추천 결과와 함께 스타일 요약, 유사 사용자 후기 노출.
4. **가상 피팅 미리보기**
   - 선택한 드레스를 합성한 결과 이미지 생성.
   - 합성 옵션(배경, 조명, 포즈, 디테일 보정) 조절.
5. **공유 및 상담 요청**
   - 생성 이미지 저장/공유(워터마크 적용).
   - 상담 예약, 실물 피팅 예약, 드레스 구매 링크 연결.
6. **프리미엄 업셀링**
   - 추가 편집(헤어·메이크업 변경), 고해상도 다운로드, 맞춤 컨설팅 구독 제안.

---

## 5. 제품 범위
### 5.1 Must Have
- 회원/세션 관리, 개인정보 동의 프로세스.
- 이미지 업로드 및 저장(S3).
- 세그멘테이션 기반 배경 제거(`POST /api/remove-background`).
- 드레스 합성(`POST /api/compose-dress`, `/api/compose-enhanced`).
- 체형 분석(`POST /api/pose-estimation`)과 스타일 추천 텍스트 생성.
- 추천 결과 목록 및 가상 피팅 미리보기 UI.
- 기본 품질 보정(`POST /api/upscale`, 이미지 보정 서버 연동).
- 로그/모델 메타 정보 저장(`composition_logs`, `dress_info`).

### 5.2 Should Have
- 다국어 프롬프트 지원 및 자동 번역.
- 사용자 맞춤 프롬프트 생성(`POST /api/gpt4o-gemini/generate-prompt`).
- GPT-4o-V2 기반 x.ai 최적화 short prompt 생성(`POST /api/prompt/generate-short`, ≤1024자).
- x.ai grok 모델 기반 이미지 분석 프롬프트 생성(`POST /api/xai/generate-prompt`).
- 통합 트라이온 파이프라인 V1 (`POST /api/tryon/unified`): X.AI 프롬프트 생성과 Gemini 2.5 Flash 이미지 합성을 단일 API 호출로 통합 (배경 이미지 포함).
- 통합 트라이온 파이프라인 V2 (`POST /api/compose_xai_gemini_v2`): SegFormer B2 Garment Parsing + X.AI 프롬프트 생성 + Gemini 2.5 Flash 이미지 합성 (배경 이미지 포함).
  - SegFormer B2 Human Parsing을 사용하여 의상만 정확히 추출 (garment_only 이미지)
  - HuggingFace Inference API를 통한 SegFormer B2 모델 호출 (로컬 모델 다운로드 불필요)
  - 추출된 garment_only 이미지로 더 정확한 프롬프트 생성 및 합성 품질 향상
  - 배경 이미지를 포함하여 자연스러운 합성 결과 생성
- 통합 트라이온 파이프라인 V2.5 (`POST /fit/v2.5/compose`): 인물 전처리 + SegFormer B2 Garment Parsing + X.AI 프롬프트 생성 + Gemini 2.5 Flash 이미지 합성 (배경 이미지 포함).
  - 인물 전처리 파이프라인 (1~5단계):
    - Step 1: SegFormer B2 Human Parsing으로 face_mask, cloth_mask, body_mask 생성
    - Step 2: face_patch 추출 (face_mask + hair_mask)
    - Step 3: base_img 생성 (cloth_mask 영역을 neutral_color(128,128,128)로 덮기)
    - Step 4: inpaint_mask 생성 (body_mask - face_mask)
    - Step 5: face_patch, base_img, inpaint_mask를 base64(PNG)로 변환
  - base_img를 Gemini에 전달하여 더 정확한 합성
  - Gemini 생성 이미지에 face_patch를 합성하고 경계 블렌딩 수행
  - 얼굴 보존 품질 향상 및 자연스러운 합성 결과
- 인물 전처리 전용 엔드포인트 (`POST /fit/v2.5/preprocess-person`): 인물 이미지만 업로드하여 face_mask, face_patch, base_img, inpaint_mask 추출 (디버깅 및 테스트용)
- 드레스 카탈로그 검색/필터(라인, 소재, 가격대 등).
- 추천 결과에 대한 피드백 수집 및 재학습 파이프라인.
- 체형 생성 기능(`POST /api/body-generation`): 얼굴이 포함된 이미지에서 얼굴+목을 보존하고 기본 체형을 생성하여 전신 이미지로 변환.

### 5.3 Could Have
- 3D 아바타/AR 뷰어 연동(`3d_conversion_test` 시나리오 기반).
- 파트너사 전용 대시보드(조회수, 전환율, 재고 업로드).
- 소셜 공유용 템플릿과 모션 그래픽.

### 5.4 Won’t Have (초기 릴리스)
- 남성/하객용 의상 추천.
- 실시간 화상 상담 기능.
- 완전 자동 3D 드레스 모델 생성.

---

## 6. 기능 상세 및 기술 요구사항
- **백엔드**: FastAPI (`main.py`), Uvicorn. GPU 환경에서 SegFormer, HR-VITON, Real-ESRGAN 등 모델 배포.
- **이미지 보정 서버**: `image_enhancement_server/enhancement_server.py`로 InstructPix2Pix + GFPGAN 조합 제공.
- **데이터베이스**: MySQL 5.7+/MariaDB 10.2+, 테이블 자동 생성(`composition_logs`, `dress_info`).
- **AI 모델**
  - SegFormer B2/B0: 의상 분할, 배경 제거.
  - Gemini 2.5 Flash & GPT-4o: 프롬프트 생성, 텍스트 추천.
  - GPT-4o-V2: x.ai 최적화 short prompt 생성 (≤1024자).
  - x.ai grok-2-vision-1212: 이미지 분석 기반 프롬프트 생성.
  - SegFormer B2 Human Parsing (`yolo12138/segformer-b2-human-parse-24`): HuggingFace Inference API를 통한 의상 추출 (garment_only 이미지 생성).
  - RTMPose-s: 포즈 추정 및 체형 지표 산출.
  - Real-ESRGAN, GFPGAN, InstructPix2Pix: 이미지 품질 보정.
  - Grok-2-vision-1212: 체형 생성 (얼굴+목 보존 전신 이미지 생성).
  - MediaPipe Face Detection: 얼굴 및 목 영역 자동 감지.
- **스토리지**: AWS S3에 업로드 이미지, 합성 결과, 로그 저장.
- **환경 구성**
  - `pip install -r requirements.txt`, CUDA 버전에 맞춘 PyTorch 설치.
  - `.env`에 데이터베이스, S3, Gemini 키 설정.
- **보안/프라이버시**
  - 업로드 이미지 암호화 저장 및 만료 정책(기본 30일).
  - 모델 처리 로그에 개인정보 마스킹.
  - GDPR/국내 개인정보보호법 준수(동의서 관리, 삭제 요청 처리).

---

## 7. 데이터 흐름 요약
1. 사용자 이미지 업로드 → S3 임시 버킷 저장.
2. 세그멘테이션 모듈이 배경 제거 → RGBA 결과 저장.
3. 체형 분석 → 측정치 및 분류 결과 DB 기록.
4. Gemini/GPT-4o로 스타일 프롬프트 생성.
5. 합성 파이프라인(`/api/compose-enhanced`) 실행 → 결과 이미지 S3 저장.
6. Real-ESRGAN/보정 서버로 후처리 → 최종 이미지 반환.
7. 사용자 피드백 및 선택 데이터 `composition_logs`에 기록 → 추천 모델 학습 데이터로 활용.

---

## 8. 성공 지표 (KPIs)
- **사용자 지표**
  - 전신 이미지 업로드 완료율 ≥ 70%.
  - 추천 드레스 클릭률(CVR) ≥ 45%.
  - 가상 피팅 결과 공유/다운로드율 ≥ 25%.
  - 프리미엄 전환율 ≥ 5%.
- **품질 지표**
  - 합성 결과 사용자 만족도 4.3/5 이상.
  - 평균 처리 시간 ≤ 45초(합성 파이프라인 기준).
  - 모델 실패율 ≤ 3%(Fallback 포함).
- **비즈니스 지표**
  - 파트너 드레스 노출 수 대비 상담 요청율 ≥ 10%.
  - 파트너 리텐션율 ≥ 80% (3개월 간 유지).

---

## 9. 릴리스 전략 및 일정(제안)
| 단계 | 기간 | 목표 | 주요 딜리버러블 |
|------|------|------|-----------------|
| Alpha | 0~2개월 | 핵심 파이프라인 검증 | 이미지 업로드, 배경 제거, 기본 합성, 내부 QA |
| Beta | 3~5개월 | 사용자 테스트 | 추천 알고리즘, 체형 분석, 프리미엄 보정, 파트너 온보딩 |
| Launch | 6개월차 | 시장 출시 | 정식 웹 릴리스, 결제/구독, 마케팅 캠페인 |
| Growth | 7개월+ | 기능 확장 | 3D 연동 PoC, 파트너 대시보드, 추천 고도화 |

- 각 단계별로 KPI와 사용자 피드백을 기반으로 기능 우선순위를 재조정.
- 모델 업데이트 및 파이프라인 안정화 작업을 스프린트 후반에 배치.

---

## 10. 리스크 및 대응
- **모델 품질 변동**: 다양한 체형/조명/포즈에서 합성 품질 저하 → 지속적 데이터 확보 및 Fine-tuning, Fallback 파이프라인 강화.
- **처리 시간 과다**: 대용량 모델 로딩으로 인한 지연 → 모델 캐싱, GPU 멀티 프로세싱, 고성능 인스턴스 고려.
- **개인정보 이슈**: 사용자 이미지 유출 우려 → 암호화 저장, 접근 로그 모니터링, 삭제 API 제공.
- **API 비용 증가**: Gemini 호출 및 GPU 운영비 부담 → 프리미엄 구독, 파트너 수수료 구조로 수익 모델 확보, 요청 캐싱.
- **파트너사 협업 난이도**: 드레스 메타데이터 표준화 부족 → CSV/관리자 포털 제공, 수동 검수 절차 마련.

---

## 11. 의존성 및 요구 리소스
- **인프라**: GPU 서버(NVIDIA 3090 등), AWS S3/CloudFront, RDS.
- **팀 구성**: ML 엔지니어 2명, 백엔드 2명, 프론트엔드 2명, 디자이너 1명, PM 1명, 웨딩 컨설턴트 1명.
- **외부 서비스**: Google Gemini API, OpenAI GPT-4o, AWS.
- **데이터 소스**: 파트너 드레스 이미지/메타데이터, 사용자 업로드 데이터(사전 동의).

---

## 12. 오픈 이슈 및 후속 과제
- 드레스 샘플 데이터셋 확보 범위/허가 상태.
- 저해상도/노이즈 이미지 처리 자동화 정책.
- 실시간 상담·AR 기능 도입 여부 및 우선순위.
- 사용자 개인정보 보관 기간 및 파트너 협약서 표준화.
- 법적 검토: 이미지 합성 결과에 대한 사용 권한, 저작권, 개인정보 동의 범위.

---

## 13. 부록
- API 상세: `docs/all_in_one.md`의 5장 참고.
- 이미지 보정 워크플로: `docs/all_in_one.md` 7~8장.
- 3D 연동 시나리오: `docs/all_in_one.md` 11장.
- 작업 로그 및 향후 계획: `docs/all_in_one.md` 12장.
- 관련 연구/레퍼런스: `docs/all_in_one.md` 부록.

